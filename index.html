<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>科技解码器 v7.0（安全精简版）</title>
<style>
  body{margin:0;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0f19;color:#e5eef7}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:8px 0 16px;display:flex;align-items:center;gap:8px}
  .tag{background:#0ea5e9;color:#001b2a;border-radius:999px;padding:2px 10px;font-weight:700}
  textarea{width:100%;min-height:220px;background:#0f172a;color:#e5eef7;border:1px solid #1f2a44;border-radius:10px;padding:12px;line-height:1.5}
  pre{white-space:pre-wrap;word-break:break-word;background:#0f172a;border:1px solid #1f2a44;border-radius:10px;padding:12px;min-height:160px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .panel{background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:12px;margin-top:12px}
  .btns{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;margin:12px 0}
  button{background:#111827;border:1px solid #24304d;color:#e5eef7;border-radius:10px;padding:10px;font-weight:700;cursor:pointer}
  button:hover{background:#0b1224}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:14px;margin:6px 0}
  .ok{color:#10b981}.warn{color:#f59e0b}.bad{color:#ef4444}
  .log{font-size:12px;max-height:140px;overflow:auto}
  .pill{display:inline-block;background:#1f2937;border:1px solid #374151;border-radius:999px;padding:2px 8px;margin-right:6px}
  .muted{opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <h1>科技解码器 <span class="tag">v7.0</span></h1>

  <div class="panel">
    <div class="grid">
      <div>
        <div class="muted">✏️ 代码输入</div>
        <textarea id="input" placeholder="粘贴需要解密/检测的 JavaScript 代码…"></textarea>
      </div>
      <div>
        <div class="muted">✨ 解密结果</div>
        <pre id="output">// 解密结果将显示在这里…</pre>
      </div>
    </div>
  </div>

  <div id="det" class="panel" style="display:none">
    <div class="muted">🔍 编码格式检测结果</div>
    <div class="kv"><div>编码类型</div><div id="d_type">-</div></div>
    <div class="kv"><div>置信度</div><div id="d_conf" class="ok">0%</div></div>
    <div class="kv"><div>特征/详情</div><div id="d_feat" class="muted">-</div></div>
    <div class="muted" id="flags"></div>
  </div>

  <div class="btns">
    <button onclick="startDecrypt()">开始解密</button>
    <button onclick="autoDetectOnly()">仅检测</button>
    <button onclick="copyResult()">复制结果</button>
    <button onclick="beautify()">代码美化</button>
    <button onclick="clearAll()">清空</button>
  </div>

  <div class="panel">
    <div class="muted">📋 执行日志</div>
    <pre id="logs" class="log"></pre>
  </div>
</div>

<script>
/* ===================== 日志 & 小工具 ===================== */
const log = (msg, level='info')=>{
  const el = document.getElementById('logs');
  const t = new Date().toLocaleTimeString();
  el.textContent += `${t} ${level.toUpperCase()}: ${msg}\n`;
  el.scrollTop = el.scrollHeight;
};
const setOut = s => document.getElementById('output').textContent = s || '// (空)';
const getIn  = () => document.getElementById('input').value.trim();

/* ===================== 执行护栏（禁用 eval/Function） ===================== */
const EvalGuards = (function(){
  let bakEval=null, bakFunc=null;
  return {
    enable(){
      if(bakEval) return;
      bakEval = window.eval;
      bakFunc = window.Function;
      window.eval = function(){ throw new Error('[guard] eval disabled'); };
      window.Function = function(){ throw new Error('[guard] Function disabled'); };
    },
    disable(){
      if(!bakEval) return;
      window.eval = bakEval;
      window.Function = bakFunc;
      bakEval = bakFunc = null;
    }
  };
})();

/* ===================== AAEncode 轻量解码器 ===================== */
(function(){
  function extractHeader(code){
    const i = code.search(/ﾟωﾟﾉ\s*=|ﾟдﾟ\s*=|ﾟДﾟ\s*=|ﾟΘﾟ\s*=/);
    return i>0 ? {header:code.slice(0,i).trim(), body:code.slice(i)} : {header:'', body:code};
  }
  function plugin(code){
    try{
      const {header, body} = extractHeader(code);
      if(!/(ﾟωﾟﾉ|ﾟДﾟ|ﾟдﾟ|ﾟΘﾟ)/.test(body)) return null;
      let s = body.replace(") ('_')","").replace("(ﾟДﾟ) ['_'] (","return ");
      const fn = new Function(s);            // 这里执行的是 AAEncode 生成的安全构造
      const out = String(fn());
      return header ? (header + '\n\n' + out) : out;
    }catch(e){ return null; }
  }
  window.DecodePlugins = window.DecodePlugins || {};
  window.DecodePlugins.aadecode = {
    detect: s => /(ﾟωﾟﾉ|ﾟДﾟ|ﾟдﾟ|ﾟΘﾟ)/.test(s),
    plugin: code => plugin(code) ?? code
  };
})();

/* ===================== 安全静态 Eval 解包器 ===================== */
(function(){
  const module = {exports:{}}, exports = module.exports;

  function unquoteLiteral(s){
    const m = s.match(/^\s*(["'`])([\s\S]*)\1\s*$/);
    if(!m) return s;
    return m[2]
      .replace(/\\n/g,'\n').replace(/\\r/g,'\r').replace(/\\t/g,'\t')
      .replace(/\\x([0-9a-fA-F]{2})/g,(_,h)=>String.fromCharCode(parseInt(h,16)))
      .replace(/\\u([0-9a-fA-F]{4})/g,(_,h)=>String.fromCharCode(parseInt(h,16)))
      .replace(/\\([\\'"`])/g,'$1');
  }
  function extractLiteralPayload(code){
    let m = code.match(/eval\s*\(\s*((["'`])[\s\S]*?\2)\s*\)/);
    if(m) return unquoteLiteral(m[1]);
    m = code.match(/(?:^|\W)(?:new\s+)?Function\s*\(\s*((["'`])[\s\S]*?\2)\s*\)/);
    if(m) return unquoteLiteral(m[1]);
    return null;
  }
  function isPacker(code){
    return /eval\s*\(\s*function\s*\(\s*p\s*,\s*a\s*,\s*c\s*,\s*k\s*,\s*e\s*,\s*d\s*\)\s*\{/.test(code);
  }
  function unpackPacker(code){
    const re=/eval\s*\(\s*function\s*\(\s*p\s*,\s*a\s*,\s*c\s*,\s*k\s*,\s*e\s*,\s*d\s*\)\s*\{[\s\S]*?\}\s*\(\s*([`'"])([\s\S]*?)\1\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\[[\s\S]*?\]|[`'"][\s\S]*?[`'"]\.split\(\s*[`'"]\|[`'"]\s*\))\s*,[\s\S]*?\)\s*\)/;
    const m=code.match(re); if(!m) return null;
    const payload=m[2], base=+m[3], count=+m[4];
    let dictRaw=m[5], dict=[];
    if(/^\[/.test(dictRaw)){ try{ dict=Function(`return ${dictRaw}`)(); }catch{ return null; } }
    else { const x=dictRaw.match(/^[`'"]([\s\S]*?)[`'"]\.split\(\s*[`'"]\|[`'"]\s*\)$/); if(!x) return null; dict=x[1].split('|'); }
    if(!dict.length) return null;
    const digits='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const baseStr=n=>{ if(n===0)return'0'; let o=''; while(n>0){ o=digits[n%base]+o; n=Math.floor(n/base); } return o; };
    let res=payload;
    for(let i=count-1;i>=0;i--){ const k=baseStr(i); if(!dict[i]) continue; res=res.replace(new RegExp('\\b'+k+'\\b','g'), dict[i]); }
    return res;
  }
  function plugin(code){
    if(isPacker(code)){ const r=unpackPacker(code); if(typeof r==='string'&&r.trim()) return r; }
    const s=extractLiteralPayload(code);
    if(s){
      try{ if(/%[0-9a-fA-F]{2}/.test(s)){ const u=decodeURIComponent(s); if(u&&u!==s) return u; } }catch{}
      try{ if(/^%(?:[0-9A-Fa-f]{2})+/.test(s)){ const u=unescape(s); if(u&&u!==s) return u; } }catch{}
      return s;
    }
    return null;
  }
  exports.plugin = plugin;

  window.DecodePlugins = window.DecodePlugins || {};
  window.DecodePlugins.eval = {
    detect: c => /eval\s*\(/.test(c) || isPacker(c),
    plugin: c => module.exports.plugin(c)
  };
  console.log('Eval 解包（安全静态版）已加载');
})();

/* ===================== 真实侦测（含版本） ===================== */
(function(){
  const has=(s,r)=> (typeof r==='string'? s.includes(r): r.test(s));
  const pick=(s,r)=>{const x=s.match(r);return x? (x[1]||x[0]):null};

  function detectJsjiami(s){
    const mark=/jsjiami\.com\.v(5|6|7)/i, head=/\b(?:var\s+)?encode_version\s*=/i, tail=/encode_version\s*=\s*['"]jsjiami\.com\.v\d+['"]/i;
    const hit = mark.test(s) || (head.test(s)&&tail.test(s));
    if(!hit) return {isDetected:false,confidence:0};
    const variant = pick(s,mark)?.replace(/[^567]/g,'') || pick(s,/v(\d)/i) || 'x';
    let c=70; if(mark.test(s))c+=15; if(head.test(s)&&tail.test(s))c+=10; if(s.length>2000)c+=3;
    return {isDetected:true,confidence:Math.min(c,98),variant,detail:'encode_version + jsjiami.com'};
  }
  function detectSojson(s){
    const mark=/(sojson\.v(5|6|7)|sojson版本)/i;
    const v7sig=/(?:^|;)!function\([\w$,]{1,6}\)\{[\s\S]{300,}?toString\(\s*36\s*\)/;
    if(!(mark.test(s)||v7sig.test(s))) return {isDetected:false,confidence:0};
    const v = pick(s,/sojson\.v(5|6|7)/i) || (v7sig.test(s)?'7':null) || 'x';
    let c=65; if(mark.test(s))c+=15; if(v7sig.test(s))c+=10; if(/debugger;|console\./.test(s))c+=5;
    return {isDetected:true,confidence:Math.min(c,95),variant:v,detail:'sojson signatures'};
  }
  function detectAAEncode(s){
    const core=/(ﾟωﾟﾉ|ﾟДﾟ|ﾟдﾟ|ﾟΘﾟ)/; if(!core.test(s)) return {isDetected:false,confidence:0};
    const feats=(s.match(/[ﾟωДдΘﾉ\(\)\^_oc]/g)||[]).length, ratio=feats/Math.max(1,s.length);
    const c=Math.min(60+Math.min(30,Math.floor(ratio*100)),95);
    return {isDetected:true,confidence:c,features:feats,ratio:Math.round(ratio*100)+'%',detail:'AAEncode glyphs'};
  }
  function detectPacker(s){
    const r=/eval\s*\(\s*function\s*\(\s*p\s*,\s*a\s*,\s*c\s*,\s*k\s*,\s*e\s*,\s*d\s*\)\s*\{/;
    if(!r.test(s)) return {isDetected:false,confidence:0};
    let c=85; if(/String\.fromCharCode|toString\(\s*36\s*\)/.test(s)) c+=5;
    return {isDetected:true,confidence:Math.min(c,95),detail:'packer pattern'};
  }
  function detectJSFuck(s){
    const body=s.replace(/\s+/g,''); if(!body) return {isDetected:false,confidence:0};
    const ok=/^[\[\]\(\)\!\+<>={}]*$/.test(body)&&body.length>80;
    return ok?{isDetected:true,confidence:92,detail:'[]()+! only'}:{isDetected:false,confidence:0};
  }
  function detectJJEncode(s){
    const sym=/(^|\b)var\s+[_$]{2,}[A-Za-z0-9_$]*\s*=\s*.*?;/, patt=/\$\$|\+_|\$_|\$__|___\$|_\$\$|__\$/;
    if(!(sym.test(s)||patt.test(s))) return {isDetected:false,confidence:0};
    let c=70; if(sym.test(s))c+=10; if((s.match(patt)||[]).length>8)c+=10;
    return {isDetected:true,confidence:Math.min(c,92),detail:'JJ symbols'};
  }
  function detectObfuscator(s){
    const arr=/var\s+_0x[a-f0-9]{4,}\s*=\s*\[/i, acc=/\[_0x[a-f0-9]{4,}\([a-z0-9_]+\)\]/i;
    if(!(arr.test(s)||acc.test(s))) return {isDetected:false,confidence:0};
    let c=70; if(arr.test(s))c+=10; if(acc.test(s))c+=10;
    return {isDetected:true,confidence:Math.min(c,93),detail:'_0x*** string array'};
  }

  window.comprehensiveDetection = function(input){
    const s=(input||'').trim(); if(!s) return {primaryType:'Unknown',primaryConfidence:0};

    const jj=detectJsjiami(s); if(jj.isDetected) return {primaryType:'jsjiami',primaryConfidence:jj.confidence,primaryResult:jj,aaResult:{isDetected:false,confidence:0},evalResult:{isDetected:false,confidence:0},hasMultipleEncodings:false};
    const sj=detectSojson(s);  if(sj.isDetected) return {primaryType:'sojson', primaryConfidence:sj.confidence,primaryResult:sj, aaResult:{isDetected:false,confidence:0},evalResult:{isDetected:false,confidence:0},hasMultipleEncodings:false};

    const aa=detectAAEncode(s), pk=detectPacker(s), jf=detectJSFuck(s), jjc=detectJJEncode(s), obf=detectObfuscator(s);
    const cand=[
      aa.isDetected && {t:'AAEncode',     c:aa.confidence, meta:aa},
      pk.isDetected && {t:'Eval(Packer)', c:pk.confidence, meta:pk},
      jf.isDetected && {t:'JSFuck',       c:jf.confidence, meta:jf},
      jjc.isDetected&& {t:'JJEncode',     c:jjc.confidence,meta:jjc},
      obf.isDetected&& {t:'Obfuscator',   c:obf.confidence,meta:obf},
    ].filter(Boolean).sort((a,b)=>b.c-a.c);

    if(!cand.length) return {primaryType:'Unknown',primaryConfidence:0,aaResult:aa,evalResult:{isDetected:pk.isDetected,confidence:pk.confidence},hasMultipleEncodings:false};
    const top=cand[0];
    return {
      primaryType: top.t,
      primaryConfidence: top.c,
      primaryResult: top.meta,
      aaResult: aa,
      evalResult: {isDetected:pk.isDetected,confidence:pk.confidence},
      hasMultipleEncodings: cand.length>1
    };
  };
  console.log('[detect] ready');
})();

/* ===================== UI：更新检测面板 ===================== */
function updateDetectionPanel(d){
  const panel=document.getElementById('det');
  if(!d || d.primaryType==='Unknown'){ panel.style.display='none'; return; }
  panel.style.display='block';
  let typeText=d.primaryType;
  if(d.primaryResult && d.primaryResult.variant){ typeText += ` (v${d.primaryResult.variant})`; }
  document.getElementById('d_type').textContent=typeText;
  const confEl=document.getElementById('d_conf');
  confEl.textContent=(d.primaryConfidence|0)+'%';
  confEl.className = d.primaryConfidence>=90?'ok':(d.primaryConfidence>=70?'warn':'bad');
  const feat = d.primaryResult?.detail || d.aaResult?.detail || '-';
  document.getElementById('d_feat').textContent = feat;
  const flags=document.getElementById('flags');
  flags.innerHTML='';
  if(d.hasMultipleEncodings){ flags.innerHTML += '<span class="pill">多重编码</span>'; }
  if(d.primaryType.startsWith('Eval')){ flags.innerHTML += '<span class="pill">Eval 检测</span>'; }
  if(d.primaryType==='AAEncode'){ flags.innerHTML += '<span class="pill">AAEncode</span>'; }
}

/* ===================== 解密分发 ===================== */
function decodeAA(code){
  log('使用 AAEncode 解码…');
  const r = window.DecodePlugins.aadecode.plugin(code);
  if(r && r!==code) return {success:true,result:String(r),method:'AAEncode'};
  return {success:false,error:'AAEncode 失败'};
}
function decodeEval(code){
  log('使用 安全静态 Eval 解包…');
  const r = window.DecodePlugins.eval.plugin(code);
  if(typeof r==='string' && r.trim() && r!==code) return {success:true,result:r,method:'Eval(静态)'};
  return {success:false,error:'未提取到有效 eval 负载'};
}
function performDecryption(code){
  const det = comprehensiveDetection(code);
  updateDetectionPanel(det);

  if(det.primaryType==='jsjiami' || det.primaryType==='sojson'){
    return {success:false,error:`侦测到 ${det.primaryType}${det.primaryResult?.variant?`(v${det.primaryResult.variant})`:''}，本工具不直接解密该类型。`, method:det.primaryType};
  }
  if(det.primaryType==='AAEncode') return decodeAA(code);
  if(det.primaryType.startsWith('Eval')) {
    const r = decodeEval(code);
    // 简单递归一层
    if(r.success && (/eval\s*\(/.test(r.result) || /function\s*\(\s*p\s*,\s*a\s*,\s*c\s*,\s*k/.test(r.result))){
      const r2 = decodeEval(r.result);
      if(r2.success) return {success:true,result:r2.result,method:'Eval(静态×2)'};
    }
    return r;
  }
  // 其它类型暂不处理，直接返回原文
  return {success:false,error:`未集成 ${det.primaryType} 的自动解包`,method:det.primaryType};
}

/* ===================== 交互 ===================== */
async function startDecrypt(){
  const s=getIn();
  if(!s){ log('请输入代码','warn'); return; }
  setOut('');
  log('开始解密…');

  EvalGuards.enable();            // 护栏开启
  try{
    const r = performDecryption(s);
    if(r.success){ setOut(r.result); log(`完成：${r.method}`,'info'); }
    else{ setOut('// 解密失败或不支持的类型'); log(r.error || '解密失败','bad'); }
  }catch(e){
    log('异常：'+e.message,'bad');
    setOut('// 解密异常：' + e.message);
  }finally{
    EvalGuards.disable();         // 护栏关闭
  }
}
function autoDetectOnly(){
  const s=getIn(); if(!s){log('请输入代码','warn');return;}
  const d = comprehensiveDetection(s);
  updateDetectionPanel(d);
  log(`检测到类型：${d.primaryType}（${d.primaryConfidence|0}%）`,'info');
}
function copyResult(){
  const t=document.getElementById('output').textContent;
  if(!t || /^\/\/ 解密结果/.test(t)) return;
  navigator.clipboard?.writeText(t).then(()=>log('结果已复制','info'));
}
function beautify(){
  const t=document.getElementById('output').textContent;
  if(!t || /^\/\/ 解密结果/.test(t)) return;
  // 极简美化：分号/大括号换行 + 缩进
  let s=t.replace(/;/g,';\n').replace(/\{/g,'{\n').replace(/\}/g,'\n}\n').replace(/\n{3,}/g,'\n\n');
  const lines=s.split('\n'); let ind=0, out=[];
  for(let ln of lines){
    ln=ln.trim(); if(!ln) continue;
    if(/^\}/.test(ln)) ind=Math.max(0,ind-1);
    out.push('  '.repeat(ind)+ln);
    if(/\{$/.test(ln)) ind++;
  }
  setOut(out.join('\n'));
  log('已美化','info');
}
function clearAll(){ document.getElementById('input').value=''; setOut('// 解密结果将显示在这里…'); document.getElementById('det').style.display='none'; document.getElementById('logs').textContent=''; }
</script>
</body>
</html>
